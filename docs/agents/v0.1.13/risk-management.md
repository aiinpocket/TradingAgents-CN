# é¢¨éšªç®¡ç†åœ˜éšŠ

## æ¦‚è¿°

é¢¨éšªç®¡ç†åœ˜éšŠæ˜¯ TradingAgents æ¡†æ¶çš„é¢¨éšªæ§åˆ¶æ ¸å¿ƒï¼Œè² è²¬å¾å¤šå€‹è§’åº¦è©•ä¼°å’Œè³ªç–‘æŠ•è³‡æ±ºç­–ï¼Œç¢ºä¿æŠ•è³‡çµ„åˆçš„é¢¨éšªå¯æ§æ€§ã€‚åœ˜éšŠç”±ä¸åŒé¢¨éšªåå¥½çš„åˆ†æå¸«çµ„æˆï¼Œé€šéå¤šè§’åº¦çš„é¢¨éšªè©•ä¼°å’Œåé§æ©Ÿåˆ¶ï¼Œç‚ºæŠ•è³‡æ±ºç­–æä¾›å…¨é¢çš„é¢¨éšªè¦–è§’å’Œä¿è­·æªæ–½ã€‚

## é¢¨éšªç®¡ç†æ¶æ§‹

### åŸºç¤è¨­è¨ˆ

é¢¨éšªç®¡ç†åœ˜éšŠåŸºæ–¼çµ±ä¸€çš„æ¶æ§‹è¨­è¨ˆï¼Œå°ˆæ³¨æ–¼é¢¨éšªè­˜åˆ¥ã€è©•ä¼°å’Œæ§åˆ¶ï¼š

```python
# çµ±ä¸€çš„é¢¨éšªç®¡ç†æ¨¡çµ„æ—¥èªŒè£é£¾å™¨
from tradingagents.utils.tool_logging import log_risk_module

# çµ±ä¸€æ—¥èªŒç³»çµ±
from tradingagents.utils.logging_init import get_logger
logger = get_logger("default")

@log_risk_module("risk_type")
def risk_node(state):
    # é¢¨éšªç®¡ç†é‚è¼¯å¯¦ç¾
    pass
```

### æ™ºèƒ½é«”ç‹€æ…‹ç®¡ç†

é¢¨éšªç®¡ç†åœ˜éšŠé€šé `AgentState` ç²å–å®Œæ•´çš„æŠ•è³‡æ±ºç­–è³‡è¨Šï¼š

```python
class AgentState:
    company_of_interest: str      # è‚¡ç¥¨ä»£ç¢¼
    trade_date: str              # äº¤æ˜“æ—¥æœŸ
    fundamentals_report: str     # åŸºæœ¬é¢å ±å‘Š
    market_report: str           # å¸‚å ´åˆ†æå ±å‘Š
    news_report: str             # æ–°èåˆ†æå ±å‘Š
    sentiment_report: str        # æƒ…ç·’åˆ†æå ±å‘Š
    trader_recommendation: str   # äº¤æ˜“å“¡å»ºè­°
    messages: List              # æ¶ˆæ¯æ­·å²
```

## é¢¨éšªç®¡ç†åœ˜éšŠæˆå“¡

### 1. ä¿å®ˆé¢¨éšªåˆ†æå¸« (Conservative Risk Analyst)

**æª”æ¡ˆä½ç½®**: `tradingagents/agents/risk_mgmt/conservative_debator.py`

**æ ¸å¿ƒè·è²¬**:
- ä½œç‚ºå®‰å…¨/ä¿å®ˆé¢¨éšªåˆ†æå¸«
- ç©æ¥µåé§æ¿€é€²å’Œä¸­æ€§åˆ†æå¸«çš„è«–é»
- æŒ‡å‡ºæ½›åœ¨é¢¨éšªä¸¦æå‡ºæ›´è¬¹æ…çš„æ›¿ä»£æ–¹æ¡ˆ
- ä¿è­·è³‡ç”¢ã€æœ€å°åŒ–æ³¢å‹•æ€§ä¸¦ç¢ºä¿ç©©å®šå¢é•·

**æ ¸å¿ƒå¯¦ç¾**:
```python
def create_safe_debator(llm):
    @log_risk_module("conservative")
    def safe_node(state):
        # ç²å–åŸºç¤è³‡è¨Š
        company_name = state["company_of_interest"]
        trader_recommendation = state.get("trader_recommendation", "")
        
        # ç²å–è‚¡ç¥¨å¸‚å ´è³‡è¨Š
        from tradingagents.utils.stock_utils import StockUtils
        market_info = StockUtils.get_market_info(company_name)
        
        # ç¢ºå®šè‚¡ç¥¨é¡å‹å’Œè²¨å¹£è³‡è¨Š
        if market_info.get("is_us"):
            stock_type = "ç¾è‚¡"
            currency_unit = "ç¾å…ƒ"
        else:
            stock_type = "æœªçŸ¥å¸‚å ´"
            currency_unit = "æœªçŸ¥è²¨å¹£"
        
        # ç²å–å„é¡åˆ†æå ±å‘Š
        market_report = state.get("market_report", "")
        sentiment_report = state.get("sentiment_report", "")
        news_report = state.get("news_report", "")
        fundamentals_report = state.get("fundamentals_report", "")
        
        # æ§‹å»ºä¿å®ˆé¢¨éšªåˆ†ææç¤º
        safe_prompt = f"""
        ä½œç‚ºå®‰å…¨/ä¿å®ˆé¢¨éšªåˆ†æå¸«ï¼Œè«‹å°ä»¥ä¸‹æŠ•è³‡æ±ºç­–é€²è¡Œé¢¨éšªè©•ä¼°ï¼š
        
        å…¬å¸åç¨±: {company_name}
        è‚¡ç¥¨é¡å‹: {stock_type}
        è²¨å¹£å–®ä½: {currency_unit}
        
        äº¤æ˜“å“¡å»ºè­°: {trader_recommendation}
        
        å¸‚å ´ç ”ç©¶å ±å‘Š: {market_report}
        æƒ…ç·’å ±å‘Š: {sentiment_report}
        æ–°èå ±å‘Š: {news_report}
        åŸºæœ¬é¢å ±å‘Š: {fundamentals_report}
        
        è«‹å¾ä¿å®ˆè§’åº¦åˆ†æï¼š
        1. è­˜åˆ¥æ‰€æœ‰æ½›åœ¨é¢¨éšªå› ç´ 
        2. è³ªç–‘æ¨‚è§€å‡è¨­çš„åˆç†æ€§
        3. æå‡ºæ›´è¬¹æ…çš„æ›¿ä»£æ–¹æ¡ˆ
        4. å»ºè­°é¢¨éšªæ§åˆ¶æªæ–½
        5. è©•ä¼°æœ€å£æƒ…æ³ä¸‹çš„æå¤±
        """
        
        # èª¿ç”¨LLMç”Ÿæˆé¢¨éšªåˆ†æ
        response = llm.invoke(safe_prompt)
        
        return {"conservative_risk_analysis": response.content}
```

**åˆ†æç‰¹é»**:
- **é¢¨éšªå„ªå…ˆ**: å„ªå…ˆè­˜åˆ¥å’Œå¼·èª¿å„é¡é¢¨éšªå› ç´ 
- **ä¿å®ˆä¼°å€¼**: å‚¾å‘æ–¼æ›´ä¿å®ˆçš„ä¼°å€¼å’Œé æœŸ
- **é˜²å¾¡ç­–ç•¥**: é‡é»é—œè¨»è³‡æœ¬ä¿è­·å’Œé¢¨éšªæ§åˆ¶
- **è³ªç–‘æ¨‚è§€**: å°æ¨‚è§€é æœŸå’Œå‡è¨­ä¿æŒè³ªç–‘æ…‹åº¦

## é¢¨éšªè©•ä¼°ç¶­åº¦

### 1. å¸‚å ´é¢¨éšª

**ç³»çµ±æ€§é¢¨éšª**:
- å®è§€ç¶“æ¿Ÿé¢¨éšª
- æ”¿ç­–ç›£ç®¡é¢¨éšª
- åˆ©ç‡åŒ¯ç‡é¢¨éšª
- åœ°ç·£æ”¿æ²»é¢¨éšª

**éç³»çµ±æ€§é¢¨éšª**:
- è¡Œæ¥­å‘¨æœŸé¢¨éšª
- å…¬å¸ç‰¹å®šé¢¨éšª
- ç®¡ç†å±¤é¢¨éšª
- ç«¶çˆ­ç’°å¢ƒé¢¨éšª

### 2. æµå‹•æ€§é¢¨éšª

**å¸‚å ´æµå‹•æ€§**:
- äº¤æ˜“é‡åˆ†æ
- è²·è³£åƒ¹å·®è©•ä¼°
- å¸‚å ´æ·±åº¦åˆ†æ
- è¡æ“Šæˆæœ¬è©•ä¼°

**è³‡é‡‘æµå‹•æ€§**:
- ç¾é‡‘æµåˆ†æ
- èè³‡èƒ½åŠ›è©•ä¼°
- å‚µå‹™åˆ°æœŸåˆ†æ
- ç‡Ÿé‹è³‡é‡‘ç®¡ç†

### 3. ä¿¡ç”¨é¢¨éšª

**è²¡å‹™é¢¨éšª**:
- å‚µå‹™è² æ“”è©•ä¼°
- å„Ÿå‚µèƒ½åŠ›åˆ†æ
- ç¾é‡‘æµç©©å®šæ€§
- ç›ˆåˆ©å“è³ªè©•ä¼°

**é‹ç‡Ÿé¢¨éšª**:
- æ¥­å‹™æ¨¡å¼é¢¨éšª
- ç®¡ç†å±¤é¢¨éšª
- å…§æ§åˆ¶åº¦é¢¨éšª
- åˆè¦é¢¨éšª

### 4. ä¼°å€¼é¢¨éšª

**ä¼°å€¼æ–¹æ³•é¢¨éšª**:
- ä¼°å€¼æ¨¡å‹é¸æ“‡
- åƒæ•¸æ•æ„Ÿæ€§åˆ†æ
- å‡è¨­æ¢ä»¶è©•ä¼°
- æ¯”è¼ƒåŸºæº–é¸æ“‡

**å¸‚å ´ä¼°å€¼é¢¨éšª**:
- å¸‚å ´æƒ…ç·’å½±éŸ¿
- ä¼°å€¼æ³¡æ²«é¢¨éšª
- åƒ¹æ ¼ç™¼ç¾æ•ˆç‡
- æŠ•è³‡è€…çµæ§‹å½±éŸ¿

## é…ç½®é¸é …

### é¢¨éšªç®¡ç†é…ç½®

```python
risk_config = {
    "risk_tolerance": "moderate",      # é¢¨éšªå®¹å¿åº¦
    "max_portfolio_var": 0.05,         # æœ€å¤§çµ„åˆVaR
    "max_single_position": 0.05,       # æœ€å¤§å–®ä¸€å€‰ä½
    "max_sector_exposure": 0.20,       # æœ€å¤§è¡Œæ¥­æ•å£
    "correlation_threshold": 0.70,     # ç›¸é—œæ€§é–¾å€¼
    "rebalance_trigger": 0.05,         # å†å¹³è¡¡è§¸ç™¼é–¾å€¼
    "stress_test_frequency": "weekly"  # å£“åŠ›æ¸¬è©¦é »ç‡
}
```

## æ—¥èªŒå’Œç›£æ§

### è©³ç´°æ—¥èªŒè¨˜éŒ„

```python
# é¢¨éšªç®¡ç†æ´»å‹•æ—¥èªŒ
logger.info(f"ğŸ›¡ï¸ [é¢¨éšªç®¡ç†] é–‹å§‹é¢¨éšªè©•ä¼°: {company_name}")
logger.info(f"ğŸ“Š [é¢¨éšªåˆ†æ] è‚¡ç¥¨é¡å‹: {stock_type}, è²¨å¹£: {currency_unit}")
logger.debug(f"âš ï¸ [é¢¨éšªå› ç´ ] è­˜åˆ¥åˆ° {len(risk_factors)} å€‹é¢¨éšªå› ç´ ")
logger.warning(f"ğŸš¨ [é¢¨éšªé è­¦] ç™¼ç¾é«˜é¢¨éšªå› ç´ : {high_risk_factors}")
logger.info(f"âœ… [é¢¨éšªè©•ä¼°] é¢¨éšªåˆ†æå®Œæˆï¼Œé¢¨éšªç­‰ç´š: {risk_level}")
```

### é¢¨éšªç›£æ§æŒ‡æ¨™

- é¢¨éšªè©•ä¼°æº–ç¢ºæ€§
- é¢¨éšªé è­¦åŠæ™‚æ€§
- é¢¨éšªæ§åˆ¶æœ‰æ•ˆæ€§
- æå¤±é æ¸¬ç²¾åº¦
- é¢¨éšªèª¿æ•´æ”¶ç›Š

## æ“´å±•æŒ‡å—

### æ·»åŠ æ–°çš„é¢¨éšªåˆ†æå¸«

1. **å‰µå»ºæ–°çš„é¢¨éšªåˆ†æå¸«æ–‡ä»¶**
```python
# tradingagents/agents/risk_mgmt/new_risk_analyst.py
from tradingagents.utils.tool_logging import log_risk_module
from tradingagents.utils.logging_init import get_logger

logger = get_logger("default")

def create_new_risk_analyst(llm):
    @log_risk_module("new_risk_type")
    def new_risk_node(state):
        # æ–°çš„é¢¨éšªåˆ†æé‚è¼¯
        pass
    
    return new_risk_node
```

2. **é›†æˆåˆ°é¢¨éšªç®¡ç†ç³»çµ±**
```python
# åœ¨ç›¸æ‡‰çš„åœ–é…ç½®ä¸­æ·»åŠ æ–°çš„é¢¨éšªåˆ†æå¸«
from tradingagents.agents.risk_mgmt.new_risk_analyst import create_new_risk_analyst

new_risk_analyst = create_new_risk_analyst(llm)
```

## æœ€ä½³å¯¦è¸

### 1. å…¨é¢é¢¨éšªè­˜åˆ¥
- ç³»çµ±æ€§è­˜åˆ¥å„é¡é¢¨éšª
- å®šæœŸæ›´æ–°é¢¨éšªæ¸…å–®
- é—œè¨»æ–°å…´é¢¨éšªå› ç´ 
- å»ºç«‹é¢¨éšªåˆ†é¡é«”ç³»

### 2. é‡åŒ–é¢¨éšªç®¡ç†
- ä½¿ç”¨å¤šç¨®é¢¨éšªæŒ‡æ¨™
- å®šæœŸæ ¡æº–é¢¨éšªæ¨¡å‹
- é€²è¡Œå›æ¸¬é©—è­‰
- æŒçºŒå„ªåŒ–åƒæ•¸

### 3. å‹•æ…‹é¢¨éšªæ§åˆ¶
- å¯¦æ™‚ç›£æ§é¢¨éšªæ°´å¹³
- åŠæ™‚èª¿æ•´é¢¨éšªæ•å£
- éˆæ´»æ‡‰å°å¸‚å ´è®ŠåŒ–
- ä¿æŒé¢¨éšªé ç®—å¹³è¡¡

### 4. é€æ˜é¢¨éšªæºé€š
- æ¸…æ™°å‚³é”é¢¨éšªè³‡è¨Š
- å®šæœŸç™¼å¸ƒé¢¨éšªå ±å‘Š
- åŠæ™‚ç™¼å‡ºé¢¨éšªé è­¦
- æä¾›é¢¨éšªæ•™è‚²åŸ¹è¨“

## æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **é¢¨éšªåˆ†æå¤±æ•—**
   - æª¢æŸ¥è¼¸å…¥æ•¸æ“šå®Œæ•´æ€§
   - é©—è­‰LLMé€£æ¥ç‹€æ…‹
   - ç¢ºèªè‚¡ç¥¨å¸‚å ´è³‡è¨Šç²å–
   - æª¢æŸ¥æ—¥èªŒè¨˜éŒ„

2. **é¢¨éšªè©•ä¼°ä¸æº–ç¢º**
   - æ›´æ–°é¢¨éšªæ¨¡å‹åƒæ•¸
   - å¢åŠ æ­·å²æ•¸æ“šæ¨£æœ¬
   - èª¿æ•´é¢¨éšªå› å­æ¬Šé‡
   - å„ªåŒ–è©•ä¼°ç®—æ³•

3. **é¢¨éšªæ§åˆ¶éåº¦ä¿å®ˆ**
   - èª¿æ•´é¢¨éšªå®¹å¿åº¦åƒæ•¸
   - å¹³è¡¡é¢¨éšªèˆ‡æ”¶ç›Šç›®æ¨™
   - å„ªåŒ–å€‰ä½ç®¡ç†ç­–ç•¥
   - è€ƒæ…®å¸‚å ´ç’°å¢ƒè®ŠåŒ–

### èª¿è©¦æŠ€å·§

1. **é¢¨éšªåˆ†æèª¿è©¦**
```python
logger.debug(f"é¢¨éšªåˆ†æè¼¸å…¥: å…¬å¸={company_name}, é¡å‹={stock_type}")
logger.debug(f"é¢¨éšªå› ç´ è­˜åˆ¥: {risk_factors}")
logger.debug(f"é¢¨éšªè©•ä¼°çµæœ: {risk_assessment}")
```

2. **ç‹€æ…‹é©—è­‰**
```python
logger.debug(f"ç‹€æ…‹æª¢æŸ¥: åŸºæœ¬é¢å ±å‘Šé•·åº¦={len(fundamentals_report)}")
logger.debug(f"ç‹€æ…‹æª¢æŸ¥: å¸‚å ´å ±å‘Šé•·åº¦={len(market_report)}")
logger.debug(f"ç‹€æ…‹æª¢æŸ¥: äº¤æ˜“å“¡å»ºè­°={trader_recommendation[:100]}...")
```

é¢¨éšªç®¡ç†åœ˜éšŠä½œç‚ºTradingAgentsæ¡†æ¶çš„å®‰å…¨å®ˆè­·è€…ï¼Œé€šéå…¨é¢çš„é¢¨éšªè­˜åˆ¥ã€è©•ä¼°å’Œæ§åˆ¶ï¼Œç¢ºä¿æŠ•è³‡æ±ºç­–åœ¨å¯æ§é¢¨éšªç¯„åœå…§é€²è¡Œï¼Œç‚ºæŠ•è³‡çµ„åˆçš„é•·æœŸç©©å¥å¢é•·æä¾›é‡è¦ä¿éšœã€‚