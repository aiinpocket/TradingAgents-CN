name: CI/CD Pipeline

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================
  # Stage 1: Build & Push Docker Image to ghcr.io
  # ============================================================
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.vars.outputs.sha_short }}
    steps:
      - uses: actions/checkout@v4

      - name: Check skip
        id: skip
        run: |
          MSG=$(git log -1 --pretty=%B)
          if echo "$MSG" | grep -q '\[skip ci\]'; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Set build variables
        if: steps.skip.outputs.skip == 'false'
        id: vars
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)
          echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        if: steps.skip.outputs.skip == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: steps.skip.outputs.skip == 'false'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        if: steps.skip.outputs.skip == 'false'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================
  # Stage 2: Update image tag in Git -> ArgoCD auto-syncs
  # ============================================================
  deploy:
    needs: build
    if: needs.build.outputs.image_tag != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Update image tag in values-production.yaml
        run: |
          TAG="${{ needs.build.outputs.image_tag }}"
          sed -i "s/^  tag: .*/  tag: \"${TAG}\"/" helm/tradingagents/values-production.yaml
          echo "Updated image.tag to ${TAG}"
          grep "tag:" helm/tradingagents/values-production.yaml

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add helm/tradingagents/values-production.yaml
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "deploy: update image tag to ${{ needs.build.outputs.image_tag }} [skip ci]"
          git push

  # ============================================================
  # Stage 3: Smoke Test
  # ============================================================
  smoke-test:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Wait for ArgoCD sync + app startup
        run: |
          echo "Waiting 120s for ArgoCD sync and application startup..."
          sleep 120

      - name: Health check
        run: |
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 \
              https://stock-us.aiinpocket.com/_stcore/health || echo "000")
            echo "Attempt ${i}: ${STATUS}"
            [ "${STATUS}" = "200" ] && echo "PASSED" && exit 0
            sleep 30
          done
          echo "::warning::Health check did not return 200 after 5 attempts"
