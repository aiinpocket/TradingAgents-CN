name: 上游同步檢查

on:
  schedule:
    # 每週一上午 9 點檢查上游更新
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # 允許手動觸發
    inputs:
      force_sync:
        description: '強制同步（跳過確認）'
        required: false
        default: 'false'
        type: boolean

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    name: 檢查上游更新

    steps:
    - name: 檢出程式碼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: 設定 Python 環境
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: 安裝依賴
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: 配置 Git
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'

    - name: 新增上游倉庫
      run: |
        git remote add upstream https://github.com/TauricResearch/TradingAgents.git || true
        git fetch upstream

    - name: 檢查上游更新
      id: check_updates
      run: |
        # 取得上游新提交數量
        NEW_COMMITS=$(git rev-list --count HEAD..upstream/main)
        echo "new_commits=$NEW_COMMITS" >> $GITHUB_OUTPUT

        if [ "$NEW_COMMITS" -gt 0 ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "發現 $NEW_COMMITS 個新提交"

          # 取得最新提交資訊
          git log --oneline --no-merges HEAD..upstream/main | head -10 > recent_commits.txt
          echo "recent_commits<<EOF" >> $GITHUB_OUTPUT
          cat recent_commits.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
          echo "沒有新的上游更新"
        fi

    - name: 分析更新類型
      if: steps.check_updates.outputs.has_updates == 'true'
      id: analyze_updates
      run: |
        # 分析提交類型
        FEATURES=$(git log --oneline --no-merges HEAD..upstream/main | grep -i -E "(feat|feature|add)" | wc -l)
        FIXES=$(git log --oneline --no-merges HEAD..upstream/main | grep -i -E "(fix|bug|patch)" | wc -l)
        DOCS=$(git log --oneline --no-merges HEAD..upstream/main | grep -i -E "(doc|readme)" | wc -l)

        echo "features=$FEATURES" >> $GITHUB_OUTPUT
        echo "fixes=$FIXES" >> $GITHUB_OUTPUT
        echo "docs=$DOCS" >> $GITHUB_OUTPUT

        # 判斷更新優先順序
        if [ "$FIXES" -gt 0 ]; then
          echo "priority=high" >> $GITHUB_OUTPUT
          echo "reason=包含 Bug 修復" >> $GITHUB_OUTPUT
        elif [ "$FEATURES" -gt 2 ]; then
          echo "priority=medium" >> $GITHUB_OUTPUT
          echo "reason=包含多個新功能" >> $GITHUB_OUTPUT
        else
          echo "priority=low" >> $GITHUB_OUTPUT
          echo "reason=常規更新" >> $GITHUB_OUTPUT
        fi

    - name: 建立 Issue 報告
      if: steps.check_updates.outputs.has_updates == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const newCommits = '${{ steps.check_updates.outputs.new_commits }}';
          const recentCommits = `${{ steps.check_updates.outputs.recent_commits }}`;
          const features = '${{ steps.analyze_updates.outputs.features }}';
          const fixes = '${{ steps.analyze_updates.outputs.fixes }}';
          const docs = '${{ steps.analyze_updates.outputs.docs }}';
          const priority = '${{ steps.analyze_updates.outputs.priority }}';
          const reason = '${{ steps.analyze_updates.outputs.reason }}';

          const issueTitle = `Upstream Update - ${newCommits} new commits`;
          const issueBody = `
          ## Update Overview

          - **New commits**: ${newCommits}
          - **Priority**: ${priority.toUpperCase()}
          - **Reason**: ${reason}

          ## Update Analysis

          - New features: ${features}
          - Bug fixes: ${fixes}
          - Doc updates: ${docs}

          ## Recent Commits

          \`\`\`
          ${recentCommits}
          \`\`\`

          ## Suggested Actions

          ${priority === 'high' ?
            '**Sync immediately** - Contains important bug fixes' :
            priority === 'medium' ?
            '**Sync this week** - Contains valuable new features' :
            '**Plan sync** - Routine update, schedule at convenience'
          }

          ## Sync Steps

          1. Check current work status
          2. Run sync script: \`python scripts/sync_upstream.py\`
          3. Resolve any conflicts
          4. Test functionality
          5. Update related documentation

          ## Related Links

          - [Upstream repo](https://github.com/TauricResearch/TradingAgents)
          - [Sync strategy docs](docs/maintenance/upstream-sync.md)
          - [Sync script](scripts/sync_upstream.py)

          ---

          *This Issue was automatically created by GitHub Actions at ${new Date().toISOString()}*
          `;

          // Check if similar Issue already exists
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'upstream-sync'
          });

          const hasOpenSyncIssue = existingIssues.data.some(issue =>
            issue.title.includes('Upstream Update')
          );

          if (!hasOpenSyncIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['upstream-sync', priority === 'high' ? 'priority-high' : priority === 'medium' ? 'priority-medium' : 'priority-low']
            });

            console.log('Created upstream update Issue');
          } else {
            console.log('Open sync Issue already exists, skipping creation');
          }

    - name: 傳送通知
      if: steps.check_updates.outputs.has_updates == 'true'
      run: |
        echo "Upstream update notification sent"
        echo "- New commits: ${{ steps.check_updates.outputs.new_commits }}"
        echo "- Priority: ${{ steps.analyze_updates.outputs.priority }}"
        echo "- Issue created for tracking"

  auto-sync:
    runs-on: ubuntu-latest
    name: 自動同步（僅限低風險更新）
    needs: check-upstream
    if: github.event.inputs.force_sync == 'true' || (needs.check-upstream.outputs.priority == 'low' && needs.check-upstream.outputs.fixes == '0')

    steps:
    - name: 檢出程式碼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: 設定 Python 環境
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: 配置 Git
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'

    - name: 新增上游倉庫
      run: |
        git remote add upstream https://github.com/TauricResearch/TradingAgents.git
        git fetch upstream

    - name: 執行自動同步
      run: |
        python scripts/sync_upstream.py --auto

    - name: 推送更新
      run: |
        git push origin main

    - name: 建立同步報告
      uses: actions/github-script@v7
      with:
        script: |
          const reportTitle = 'Auto sync completed';
          const reportBody = `
          ## Auto Sync Successful

          GitHub Actions has completed upstream sync automatically.

          **Sync time**: ${new Date().toISOString()}
          **Trigger**: ${context.eventName === 'workflow_dispatch' ? 'Manual' : 'Automatic'}

          ## Follow-up

          1. Check synced changes are working correctly
          2. Run local tests to verify functionality
          3. Update related documentation (if needed)

          ---

          *This report was automatically generated by GitHub Actions*
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: reportTitle,
            body: reportBody,
            labels: ['upstream-sync', 'auto-sync']
          });
